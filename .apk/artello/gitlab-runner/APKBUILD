# Contributor: Zack Siri <zack@artellectual.com>
# Maintainer: Zack Siri <zack@artellectual.com>
pkgname=gitlab-runner
pkgdesc="Gitlab Runner"
pkgver=10.8.0
pkgrel=0
url="https://docs.gitlab.com/runner"

arch="x86_64"
options="!check"
license="MIT"

depends="
  bash
  ca-certificates
  git
  openssl
  tzdata
  wget
"

pkgusers="builder"
pkggroups="builder"

install="
  ${pkgname}.pre-install
  ${pkgname}.post-install
"

source="
  gitlab-runner-linux-amd64
  $pkgname.initd
  config.toml
  service/run
"

builddir="${srcdir}"

snapshot() {
  abuild clean
  abuild deps

  cd $startdir
  wget "https://gitlab-runner-downloads.s3.amazonaws.com/v${pkgver}/binaries/gitlab-runner-linux-amd64"

  abuild checksum
}

build() {
  cd "$builddir"
}

package() {
  mkdir -p "$pkgdir"

  cd "$pkgdir"
  
  install -dm755 -o $pkgusers -g $pkggroups ./var/lib/"$pkgname"
  install -dm755 -o $pkgusers -g $pkggroups ./etc/"$pkgname"

  install -Dm755 "$builddir"/$pkgname.initd ./etc/init.d/$pkgname
  install -Dm755 "$builddir"/"$pkgname-linux-amd64" ./usr/bin/$pkgname
  install -Dm644 "$builddir"/config.toml ./etc/$pkgname/config.toml
  install -Dm755 "$builddir"/run ./var/lib/$pkgname/service/run
}
